{% extends "base.html" %}

{% block content %}
<div class="space-y-12">
    <h1 class="text-4xl font-bold text-center text-gray-800">Influra MVP</h1>

    <!-- LinkedIn Login/Status -->
    <div class="bg-white p-6 rounded-lg shadow-md text-center">
        <h2 class="text-2xl font-semibold mb-4">LinkedIn Integration</h2>
        {% if request.session.linkedin_token %}
        <p class="text-green-600 font-semibold">&#x2713; Connected to LinkedIn</p>
        {% else %}
        <p class="text-gray-600 mb-4">Connect your LinkedIn account to enable direct posting.</p>
        <a href="/auth/login" class="inline-block bg-blue-700 text-white py-2 px-4 rounded-md hover:bg-blue-800">Login with LinkedIn</a>
        {% endif %}

        {% if request.query_params.get('linkedin_success') %}
        <div class="mt-4 p-3 bg-green-100 text-green-700 rounded-lg">Post successfully shared to LinkedIn!</div>
        {% elif request.query_params.get('linkedin_error') %}
        <div class="mt-4 p-3 bg-red-100 text-red-700 rounded-lg">Error sharing post to LinkedIn. Please check server logs.</div>
        {% endif %}
    </div>

    <!-- Step 1 & 2: Analysis Forms & Results -->
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
        <!-- Profile Analysis -->
        <div class="bg-white p-6 rounded-lg shadow-md">
            <h2 class="text-2xl font-semibold mb-4">Your Profile Analysis</h2>
            {% if profile_summary and not profile_summary.error %}
            <div class="mt-6 p-4 bg-blue-50 rounded-lg">
                <h3 class="font-semibold text-lg mb-2">Profile Summary:</h3>
                <p><strong>Tone:</strong> {{ profile_summary.tone }}</p>
                <p><strong>Niche:</strong> {{ profile_summary.niche }}</p>
                <p><strong>Voice:</strong> {{ profile_summary.voice }}</p>
                <p><strong>Strengths:</strong></p>
                <ul class="list-disc list-inside ml-4">
                    {% for strength in profile_summary.strengths %}<li>{{ strength }}</li>{% endfor %}
                </ul>
            </div>
            {% elif profile_summary and profile_summary.error %}
            <div class="mt-6 p-4 bg-red-100 text-red-700 rounded-lg">
                <p><strong>Error analyzing profile:</strong> {{ profile_summary.error }}</p>
            </div>
            {% else %}
            <p class="text-gray-600">Your profile analysis will appear here once it's ready.</p>
            {% endif %}
        </div>

        <!-- Trend Analysis -->
        <div class="bg-white p-6 rounded-lg shadow-md">
            <h2 class="text-2xl font-semibold mb-4">2. Analyze Trend / News</h2>
            <form action="/trends/analyze" method="post">
                <textarea name="text" rows="8" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm" placeholder="Paste Trend or News Text..."></textarea>
                <button type="submit" class="mt-4 w-full bg-green-600 text-white py-2 px-4 rounded-md hover:bg-green-700">Distill Insights</button>
            </form>
            {% if trend_insights and not trend_insights.error %}
            <div class="mt-6 p-4 bg-green-50 rounded-lg">
                <h3 class="font-semibold text-lg mb-2">Trend Insights:</h3>
                <ul class="list-disc list-inside ml-4">
                    {% for insight in trend_insights.insights %}<li>{{ insight }}</li>{% endfor %}
                </ul>
            </div>
            {% elif trend_insights and trend_insights.error %}
            <div class="mt-6 p-4 bg-red-100 text-red-700 rounded-lg">
                <p><strong>Error analyzing trends:</strong> {{ trend_insights.error }}</p>
            </div>
            {% endif %}
        </div>
    </div>

    <!-- New Section: Image Analysis -->
    <div class="bg-white p-6 rounded-lg shadow-md">
        <h2 class="text-2xl font-semibold mb-4">2.5. Analyze Image</h2>
        <form action="/image/analyze" method="post" enctype="multipart/form-data">
            <label for="image_file" class="block text-sm font-medium text-gray-700">Upload Image for Analysis:</label>
            <input type="file" name="images" id="image_file" accept="image/*" multiple class="mt-1 block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100"/>
            <button type="submit" class="mt-4 w-full bg-yellow-600 text-white py-2 px-4 rounded-md hover:bg-yellow-700">Analyze Image</button>
        </form>
        {% if image_analysis and not image_analysis.error %}
        <div class="mt-6 p-4 bg-yellow-50 rounded-lg">
            <h3 class="font-semibold text-lg mb-2">Image Analysis:</h3>
            <p>{{ image_analysis.description }}</p>
            {% if image_analysis.tags %}
            <p class="mt-2"><strong>Tags:</strong> {{ image_analysis.tags | join(', ') }}</p>
            {% endif %}
        </div>
        {% elif image_analysis and image_analysis.error %}
        <div class="mt-6 p-4 bg-red-100 text-red-700 rounded-lg">
            <p><strong>Error analyzing image:</strong> {{ image_analysis.error }}</p>
        </div>
        {% endif %}
    </div>

    <!-- Step 3: Post Generation & Saving -->
    <div class="bg-white p-6 rounded-lg shadow-md">
        <h2 class="text-2xl font-semibold mb-4">3. Generate & Save Post</h2>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <form action="/post/generate" method="post">
                <label for="manual_context" class="block text-sm font-medium text-gray-700">Add Manual Context (Optional):</label>
                <textarea name="manual_context" id="manual_context" rows="4" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm" placeholder="e.g., Mention the upcoming product launch on Friday."></textarea>
                <p class="text-sm text-gray-600 my-4">Uses the latest analysis results from above and any manual context you provide.</p>
                <button type="submit" class="w-full bg-purple-600 text-white py-2 px-4 rounded-md hover:bg-purple-700">Generate Post</button>
            </form>
            {% if generated_post and not generated_post.error %}
            <form action="/posts/save" method="post">
                <textarea name="generated_post_content" rows="10" class="mt-4 block w-full rounded-md border-gray-300 shadow-sm" readonly>{{ generated_post.post }}</textarea>
                <p class="mt-2 text-sm text-gray-600"><strong>Hashtags:</strong> {{ generated_post.hashtags | join(', ') }}</p>
                <button type="submit" class="mt-4 w-full bg-indigo-600 text-white py-2 px-4 rounded-md hover:bg-indigo-700">Save Draft</button>
            </form>
            {% elif generated_post and generated_post.error %}
            <div class="mt-6 p-4 bg-red-100 text-red-700 rounded-lg">
                <p><strong>Error generating post:</strong> {{ generated_post.error }}</p>
            </div>
            {% endif %}
        </div>
    </div>

    <!-- Step 4: Drafts Dashboard & Exports -->
    <div class="bg-white p-6 rounded-lg shadow-md">
        <form id="delete-drafts-form" action="/posts/delete" method="post">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-2xl font-semibold">4. Saved Drafts</h2>
                <div class="space-x-2">
                    <button type="submit" class="bg-red-600 text-white py-2 px-4 rounded-md hover:bg-red-700 text-sm">Delete Selected</button>
                    <a href="/export/md" class="bg-gray-600 text-white py-2 px-4 rounded-md hover:bg-gray-700 text-sm">Export to .MD</a>
                    <a href="/export/csv" class="bg-gray-600 text-white py-2 px-4 rounded-md hover:bg-gray-700 text-sm">Export to .CSV</a>
                </div>
            </div>
            <div class="overflow-x-auto">
                <table class="min-w-full bg-white border">
                    <thead class="bg-gray-200">
                        <tr>
                            <th class="py-2 px-4 border-b w-12"></th>
                            <th class="py-2 px-4 border-b">ID</th>
                            <th class="py-2 px-4 border-b">Content</th>
                            <th class="py-2 px-4 border-b">Status</th>
                            <th class="py-2 px-4 border-b">Created At</th>
                            <th class="py-2 px-4 border-b">Action</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for post in saved_posts %}
                        <tr class="hover:bg-gray-50">
                            <td class="py-2 px-4 border-b text-center">
                                <input type="checkbox" name="post_ids" value="{{ post.id }}" class="rounded border-gray-300 text-indigo-600 shadow-sm focus:border-indigo-300 focus:ring focus:ring-indigo-200 focus:ring-opacity-50">
                            </td>
                            <td class="py-2 px-4 border-b text-center">{{ post.id }}</td>
                            <td class="py-2 px-4 border-b text-sm">{{ post.content[:100] }}...</td>
                            <td class="py-2 px-4 border-b text-center"><span class="px-2 py-1 text-xs font-semibold rounded-full {{ 'bg-green-200 text-green-800' if post.status == 'posted' else 'bg-yellow-200 text-yellow-800' }}">{{ post.status }}</span></td>
                            <td class="py-2 px-4 border-b text-sm">{{ post.created_at }}</td>
                            <td class="py-2 px-4 border-b text-center">
                                {% if post.status == 'draft' %}
                                <form action="/posts/{{ post.id }}/share" method="post" class="inline-block">
                                    <button type="submit" class="bg-teal-500 text-white py-1 px-3 rounded-md hover:bg-teal-600 text-xs">Post to LinkedIn</button>
                                </form>
                                {% else %}
                                <span class="text-gray-500 text-xs">Posted</span>
                                {% endif %}
                            </td>
                        </tr>
                        {% else %}
                        <tr>
                            <td colspan="6" class="py-4 px-4 text-center text-gray-500">No drafts saved yet.</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </form>
    </div>
</div>

<script>
document.getElementById('delete-drafts-form').addEventListener('submit', function(event) {
    event.preventDefault(); // Stop the form from submitting immediately

    const checkedBoxes = this.querySelectorAll('input[name="post_ids"]:checked');
    const count = checkedBoxes.length;

    if (count === 0) {
        alert('Please select at least one draft to delete.');
        return; // Stop if no drafts are selected
    }

    const confirmation = confirm(`Are you sure you want to delete ${count} selected draft(s)? This action cannot be undone.`);

    if (confirmation) {
        this.submit(); // Proceed with form submission
    }
});
</script>
{% endblock %}